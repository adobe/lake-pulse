# Copyright 2025 Adobe. All rights reserved.
# This file is licensed to you under the Apache License,
# Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
# or the MIT license (http://opensource.org/licenses/MIT),
# at your option.
#
# Unless required by applicable law or agreed to in writing,
# this software is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR REPRESENTATIONS OF ANY KIND, either express or
# implied. See the LICENSE-MIT and LICENSE-APACHE files for the
# specific language governing permissions and limitations under
# each license.

# =============================================================================
# Release PR Status Workflow
# =============================================================================
#
# PURPOSE:
# Sets the "required" status check to success for release PRs created by
# release-plz, allowing them to be merged without running full CI.
#
# WHY THIS IS NEEDED:
# 1. We use release-plz to automate version bumps and changelog updates.
# 2. release-plz creates PRs using GITHUB_TOKEN (not a PAT or GitHub App).
# 3. GitHub's security model prevents workflows triggered by GITHUB_TOKEN
#    from triggering other workflows (to prevent infinite loops).
# 4. This means our normal CI workflow (ci.yml) never runs on release PRs.
# 5. Without this workflow, the "required" status check shows yellow "waiting"
#    forever, which looks unprofessional and confusing.
#
# WHY NOT USE A PAT OR GITHUB APP?
# - PAT: Tied to a personal account, requires manual rotation, bus factor.
# - GitHub App: Requires org admin access to create, which we don't have.
#
# HOW IT WORKS:
# 1. Uses `pull_request_target` event which runs in the base branch context
#    and triggers regardless of who created the PR (bot or human).
# 2. Verifies it's a legitimate release PR by checking BOTH:
#    - Branch name starts with "release-plz-" (release-plz's default prefix)
#    - PR has the "release" label (configured in release-plz.toml)
# 3. Uses GitHub API to set the "required" status check to success.
#
# SECURITY:
# The branch prefix check prevents abuse - only branches starting with
# "release-plz-" can bypass CI. For 'labeled' events, we also verify the
# 'release' label is present. For other events (opened, synchronize, reopened),
# we only check the branch prefix because release-plz may add the label AFTER
# pushing, causing a race condition.

name: Release PR Status

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  set-status:
    name: Set Release PR Status
    # For 'labeled' events: require BOTH the branch prefix AND the release label
    # For other events (opened, synchronize, reopened): only check branch prefix
    # This handles the race condition where release-plz adds the label AFTER pushing
    # Also ensure the PR is still open (not merged or closed)
    if: |
      github.event.pull_request.state == 'open' &&
      startsWith(github.head_ref, 'release-plz-') &&
      (github.event.action != 'labeled' || contains(github.event.pull_request.labels.*.name, 'release'))
    runs-on: ubuntu-latest
    permissions:
      statuses: write
    steps:
      - name: Set required status to success
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f state='success' \
            -f context='required' \
            -f description='Release PR - CI not required'

