# Copyright 2025 Adobe. All rights reserved.
# This file is licensed to you under the Apache License,
# Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
# or the MIT license (http://opensource.org/licenses/MIT),
# at your option.
#
# Unless required by applicable law or agreed to in writing,
# this software is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR REPRESENTATIONS OF ANY KIND, either express or
# implied. See the LICENSE-MIT and LICENSE-APACHE files for the
# specific language governing permissions and limitations under
# each license.

name: Release

on:
  push:
    branches:
      - main

jobs:
  # Release unpublished packages to crates.io
  release-plz-release:
    name: Release
    runs-on: ubuntu-latest
    # Only run in the main repository, not in forks
    if: ${{ github.repository_owner == 'adobe' }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run release-plz release
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create/update a PR with version bumps and changelog updates
  release-plz-pr:
    name: Release PR
    runs-on: ubuntu-latest
    # Only run in the main repository, not in forks
    if: ${{ github.repository_owner == 'adobe' }}
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run release-plz release-pr
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Set the "required" status to success for release PRs.
  # This runs as a separate job AFTER release-plz-pr completes to ensure
  # we get the final SHA (release-plz action may have post-hooks that push).
  release-pr-status:
    name: Release PR Status
    runs-on: ubuntu-latest
    needs: release-plz-pr
    if: ${{ github.repository_owner == 'adobe' }}
    permissions:
      statuses: write
      pull-requests: read
    steps:
      - name: Set release PR status to success
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find open release PRs by branch prefix
          PR_NUMBERS=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --json number,headRefName \
            --jq '.[] | select(.headRefName | startswith("release-plz-")) | .number')

          if [[ -z "$PR_NUMBERS" ]]; then
            echo "No release PRs found. Skipping."
            exit 0
          fi

          echo "$PR_NUMBERS" | while read -r PR_NUMBER; do
            PR_SHA=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRefOid --jq '.headRefOid')
            echo "Setting required status to success for PR #$PR_NUMBER (SHA: $PR_SHA)"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/statuses/$PR_SHA" \
              -f state='success' \
              -f context='required' \
              -f description='Release PR - CI not required'
          done

