# Copyright 2025 Adobe. All rights reserved.
# This file is licensed to you under the Apache License,
# Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
# or the MIT license (http://opensource.org/licenses/MIT),
# at your option.
#
# Unless required by applicable law or agreed to in writing,
# this software is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR REPRESENTATIONS OF ANY KIND, either express or
# implied. See the LICENSE-MIT and LICENSE-APACHE files for the
# specific language governing permissions and limitations under
# each license.

name: Release

on:
  push:
    branches:
      - main

jobs:
  # Release unpublished packages to crates.io
  release-plz-release:
    name: Release
    runs-on: ubuntu-latest
    # Only run in the main repository, not in forks
    if: ${{ github.repository_owner == 'adobe' }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run release-plz release
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create/update a PR with version bumps and changelog updates
  release-plz-pr:
    name: Release PR
    runs-on: ubuntu-latest
    # Only run in the main repository, not in forks
    if: ${{ github.repository_owner == 'adobe' }}
    permissions:
      contents: write
      pull-requests: write
      statuses: write
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run release-plz release-pr
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Set the "required" status to success for release PRs.
      # Release PRs do contain changes that are already validated and merged
      # so no need to re-run CI.
      # This is needed because PRs created by GITHUB_TOKEN don't trigger
      # other workflows, leaving the "required" status pending.
      - name: Set release PR status to success
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find all open release PRs (branch starts with "release-plz-")
          PR_SHAS=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --head "release-plz-" \
            --json headRefOid \
            --jq '.[].headRefOid')

          if [[ -z "$PR_SHAS" ]]; then
            echo "No open release PRs found. Skipping status update."
            exit 0
          fi

          echo "$PR_SHAS" | while read -r PR_SHA; do
            echo "Setting required status to success for SHA: $PR_SHA"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/statuses/$PR_SHA" \
              -f state='success' \
              -f context='required' \
              -f description='Release PR - CI not required'
          done

